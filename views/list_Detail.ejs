<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>글조회 페이지</title>
</head>
<style>
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
<script>
  //이 페이지가 랜딩되고 있는 url의 쿼리스트링 가져오기
  let PostId = new URLSearchParams(location.search).get('PostId')
  // console.log(PostId); //ok 

  $(document).ready(function () { //주석
    get_detail()
    call_comment();
  });


  function get_detail() {
    $.ajax({
      type: "GET",
      url: `blogList/${PostId}`,
      dataType: "json",
      data: {},
      success: function (response) {

        //routes에서 보내준 값 받음. 
        let blogList = response["blogList"]
        //console.log(blogList);//브라우저 콘솔에서 나온다.ok 

        let subject = blogList["subject"]
        let NowDate = blogList["NowDate"]
        let nick = blogList["nick"]
        let content = blogList["content"]

        let temp_html = `<h1>글조회 페이지</h1>
                            <div>
                              <h5> 글제목: ${subject}<h5>
                              <h5>작성시간: ${NowDate}<h5>
                              <h5>작성자명: ${nick}<h5>
                              <h5>글내용: ${content}<h5>
                            </div>`
        $('#detailAppend').append(temp_html)

      }
    })
  }


function modify_detail(blogList) {
  location.href = "modify?PostId=" + PostId
}

  function remove_validation() {
    $.ajax({
      type: "GET",
      url: `blogList/${PostId}`,
      data: {},
      success: function (response) {
        let blogList = response["blogList"];
        //console.log(blogList)
        //db에 저장된 비밀번호 가져오기
        let password_write = blogList['password_write']
        //비밀번호 입력창에 입력한 값과 db로 가져온 pwd를 비교하여 검사
        if (password_write === Number($("#password_write").val())) {
          remove()
        }
        else {
          alert("비밀번호가 다릅니다.");
        }
      }
    });
  }

  function remove() {
    $.ajax({
      type: "DELETE",
      url: `blogList/${PostId}`,
      data: {},
      success: function (response) {
        if (response["result"] == "success") {
          location.href = "/blog/list"
        }
      }
    });
  }


  // 댓글 보여주기 
  function call_comment() {
    //이 페이지가 랜딩되고 있는 url의 쿼리스트링 가져오기
    let PostId = new URLSearchParams(location.search).get('PostId')

    $.ajax({
      type: 'GET',
      url: `lookupComment/${PostId}`,
      contentType: "application/json",
      data: {},

      success: function (response) {

        let raw = response //sorted_total_ls
        for (let i = 0; i < raw.length; i++) {
          let UserId = raw[i]['UserId'];
          let comment = raw[i]['comment'];
          let CommentId = raw[i]['CommentId']
          let NowDate = raw[i]['NowDate'];

          let temp_html = `
                                    <!-- 댓글 시작 -->
                                    <div class="card" style="width: 1300px; padding: 15px;">
                                        <div class="row">
                                            <!-- 내용 -->
                                            <div class="col-lg-3">
                                                <div class="card-body">
                                                ${comment}
                                                </div>
                                            </div>
                                            <!-- 공백 -->
                                            <div class="col-lg-1">
                                     
                                            </div>
                                            <!-- 이름 -->
                                            <div class="col-lg-2">
                                                작성자: ${UserId}
                                            </div>
                                            <!-- 날짜 -->
                                            <div class="col-lg-3" id="Date">
                                                작성일자: ${NowDate}
                                            </div>
                                            <!-- 댓글ID -->
                                            <div class="col-lg-1" id="${CommentId}">
                                                댓글 고유ID: ${CommentId}
                                            </div>
                                            <!-- 버튼 -->
                                            <div class="col-lg-2" style="padding: 15px; margin: auto">
                                                <button type="button" onclick="update_comment_auth(${CommentId})">수정</button>
                                            </div>
                                        </div>
                                    </div>
                                    <p></p>
                                    `

          $('#commentAppend').append(temp_html)
        }
      }
    })

  }

  // 댓글작성
  function posting_comment_auth() {
    let PostId = new URLSearchParams(location.search).get('PostId')
    let comment = $("#comment").val()

    $.ajax({
      type: 'POST',
      url: 'postingComment',
      contentType: "application/json",
      xhrFields: { withCredentials: true },
      data: JSON.stringify({
        comment: comment,
        PostId: PostId,
      }),

      success: function (response) {
        alert(response["msg"])
        window.location.reload()
      },
      error: function (jqXHR, textStatus, errorThrown) {
        alert(jqXHR.responseText)
        window.location.reload()
      }
    })
  }

  // 댓글수정기능 // 인증미들웨어에 콜하기
  function update_comment_auth(CommentId) {
    let PostId = new URLSearchParams(location.search).get('PostId')

    $.ajax({
      type: 'POST',
      url: 'updateCommentAuth',
      contentType: "application/json",
      xhrFields: { withCredentials: true },
      data: JSON.stringify({
        CommentId: CommentId,
        PostId: PostId,
      }),

      success: function (response) {
        document.location.href = `/blog/modifyComment?CommentId=${CommentId}&PostId=${PostId}`
      },
      error: function (jqXHR, textStatus, errorThrown) {
        alert("로그인이 필요한 기능입니다.")
        window.location.replace("/user/login");
      },
    })
  }
</script>



<body>
  <!-- 상세페이지 컨트롤 -->
  <div id="detailAppend" name="detailAppend">

    <div class="btncls">
      <button class="btn btn-primary" type="submit" onclick="modify_detail()">수정</button></br></br>

    </div>
    <a></a>비밀번호를 입력하세요</a></br>
    <input class="inputPwd" id="password_write" type="number" placeholder="숫자를 입력하세요" />
    <button class="btn btn-primary" type="submit" onclick="remove_validation()">삭제</button>
  </div>


  <!-- 댓글 작성 -->
  댓글 달기</br> <textarea rows="3" id="comment"></textarea></br>
  <button type="button" class="btn btn-success" onclick="posting_comment_auth()">등록</button>
  </div>


  <!-- 댓글 창 -->
  <div id="commentAppend">
  </div>

</html>